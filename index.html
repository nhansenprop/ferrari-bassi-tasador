<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ferrari Bassi ¬∑ Tasaci√≥n preliminar (CABA)</title>
  <style>
    :root {
      --bg:#0b0d10; --panel:#151a20; --muted:#9fb0c8; --text:#e8eff7; --brand:#3fb389; --bad:#d26b6b; --good:#6bd294;
    }
    *{box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"}
    body{background:var(--bg); color:var(--text); margin:0; padding:22px}
    h1{margin:0 0 14px; font-weight:800; letter-spacing:.2px}
    .grid{display:grid; gap:18px; grid-template-columns: 1fr;}
    @media (min-width:960px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .card{background:var(--panel); border:1px solid #212934; padding:18px; border-radius:16px; box-shadow:0 8px 26px rgba(0,0,0,.25)}
    label{display:block; margin:8px 0 6px; color:var(--muted); font-size:.92rem}
    input, select{width:100%; padding:12px 12px; border-radius:12px; border:1px solid #2a3442; background:#0e1318; color:var(--text); outline:none}
    input:focus, select:focus{border-color:#3b8fff}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .right h2{margin:0 0 6px}
    .price{font-size:34px; font-weight:800}
    .muted{color:var(--muted)}
    .btn{display:inline-block; padding:12px 16px; border-radius:12px; background:var(--brand); color:#07120e; border:none; font-weight:700; cursor:pointer}
    .btn.secondary{background:#263042; color:#cfe3ff; border:1px solid #36455b}
    .note{font-size:.92rem; color:#b7c6dc}
    .inline{display:flex; gap:8px; align-items:center}
    .chip{padding:6px 10px; border-radius:999px; background:#0e1318; border:1px solid #273140; color:#cfe3ff; font-size:.82rem}
    .field-suffix{display:flex; gap:8px; align-items:center}
    .field-suffix input{flex:1}
    .ok{color:var(--good)} .warn{color:#f2d675} .bad{color:var(--bad)}
    .divider{height:1px; background:#232d3a; margin:14px 0}
    a{color:#8ad9ff}
    small.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#9cc3ff}
  </style>
</head>
<body>
  <h1>Ferrari Bassi ¬∑ Tasaci√≥n preliminar</h1>
  <div class="grid">
    <div class="card">
      <label>Direcci√≥n (calle y altura) ‚Äî CABA</label>
      <div class="field-suffix">
        <input id="direccion" placeholder="Ej: Castex 3428" autocomplete="street-address" />
        <button class="btn secondary" onclick="detectarBarrio()">Detectar barrio</button>
      </div>
      <div class="muted" id="barrioStatus" style="margin-top:6px"></div>

      <label style="margin-top:14px">Superficie cubierta (m¬≤)</label>
      <input id="sup" type="number" min="10" step="1" value="60"/>

      <div class="row">
        <div>
          <label>Ambientes</label>
          <input id="amb" type="number" min="1" step="1" value="2"/>
        </div>
        <div>
          <label>Ba√±os</label>
          <input id="ban" type="number" min="1" step="1" value="1"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Piso</label>
          <input id="piso" type="number" min="0" step="1" value="3"/>
        </div>
        <div>
          <label>Antig√ºedad (a√±os)</label>
          <input id="ant" type="number" min="0" step="1" value="30"/>
        </div>
      </div>

      <label>Estado</label>
      <select id="estado">
        <option value="-0.12">A reciclar (‚Äì12%)</option>
        <option value="-0.05">Bueno (‚Äì5%)</option>
        <option value="0" selected>Muy bueno (0%)</option>
        <option value="0.06">Excelente (+6%)</option>
      </select>

      <div class="row3" style="margin-top:8px">
        <label class="inline"><input type="checkbox" id="coch"/> Cochera</label>
        <label class="inline"><input type="checkbox" id="pile"/> Pileta</label>
        <label class="inline"><input type="checkbox" id="seg"/> Seguridad 24/7</label>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" onclick="calcular()">Calcular precio</button>
        <a id="ctaWsp" class="btn secondary" target="_blank" rel="noopener">WhatsApp: solicitar tasaci√≥n</a>
      </div>

      <div class="divider"></div>
      <div class="note">
        <b>Fuentes usadas</b>: geocodificaci√≥n USIG (barrio seg√∫n direcci√≥n) y valor de m¬≤ por barrio provisto por Mudafy (actualizado a <span id="fechaFuente">julio 2025</span>). Promedio CABA de respaldo (Zonaprop Index). Esto es <b>orientativo</b>; no reemplaza visita profesional ni verificaci√≥n documental.
      </div>
    </div>

    <div class="card right">
      <h2>Precio sugerido de publicaci√≥n</h2>
      <div class="price" id="precioPub">‚Äî</div>
      <div class="muted" id="rango">‚Äî</div>

      <h2 style="margin-top:20px">Precio estimado de cierre (‚Äì6,8%)</h2>
      <div class="price" id="precioCierre">‚Äî</div>

      <div class="divider"></div>
      <div class="note">
        <div id="barrioInfo">Barrio: ‚Äî</div>
        <div id="baseInfo">Base usada: CABA promedio ‚Äî</div>
        <div id="ajustesInfo">Ajustes aplicados: ‚Äî</div>
      </div>
    </div>
  </div>

  <script>
    // --- Datos reales por barrio (USD/m2) ‚Äî Fuente: Mudafy (valores a julio 2025)
    // https://mudafy.com.ar/d/valor-metro-cuadrado-en-caba-por-barrio
    const preciosMudafy = {
      "Agronom√≠a":1540, "Almagro":1818, "Balvanera":1449, "Barracas":1488,
      "Belgrano":2526, "Boedo":1695, "Caballito":1952, "Chacarita":2136,
      "Colegiales":2334, "Coghlan":1956, "Constituci√≥n":1152, "Flores":1652,
      "Floresta":1365, "La Boca":905, "Liniers":1326, "Mataderos":1190,
      "Monte Castro":1438, "Monserrat":1540, "Nueva Pompeya":870,
      "N√∫√±ez":2569, "Nu√±ez":2569, "Palermo":2631, "Parque Avellaneda":1104,
      "Parque Chacabuco":1758, "Parque Chas":1965, "Parque Patricios":1151,
      "Paternal":1312, "La Paternal":1312, "Puerto Madero":4681, "Recoleta":2459,
      "Retiro":1882, "Saavedra":1991, "San Crist√≥bal":1513, "San Cristobal":1513,
      "San Nicol√°s":1785, "San Nicolas":1785, "San Telmo":1831, "Versalles":1288,
      "Villa Crespo":2085, "Villa Devoto":2151, "Villa Lugano":880, "Villa Luro":1541,
      "Villa Ort√∫zar":1941, "Villa Ortu zar":1941, "Villa Ortuzar":1941,
      "Villa Pueyrred√≥n":1711, "Villa Pueyrredon":1711, "Villa Riachuelo":878,
      "Villa Santa Rita":1637, "Villa Soldati":681, "Villa Urquiza":2212, "Villa Real":1382
    };

    // Promedio CABA de respaldo (departamentos) ‚Äî Zonaprop Index Jul 2025
    // https://www.zonaprop.com.ar/noticias/wp-content/uploads/2025/07/INDEX_CABA_REPORTE_2025-07.pdf
    const CABA_PROMEDIO_USD_M2 = 2440;

    // Normaliza textos para comparaciones acento/espacio/caso
    const norm = s => (s||"").toString().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').toLowerCase();

    // Estado actual de barrio detectado
    let barrioDetectado = null;

    async function detectarBarrio(){
      const raw = document.getElementById('direccion').value.trim();
      if(!raw){
        document.getElementById('barrioStatus').innerHTML = '<span class="bad">Ingres√° calle y altura en CABA.</span>';
        return;
      }

      // Partimos por el √∫ltimo token num√©rico como altura
      const m = raw.match(/^(.*?)(\d{1,5})([^\d]*)$/);
      if(!m){
        document.getElementById('barrioStatus').innerHTML = '<span class="bad">Formato esperado: "Calle 1234".</span>';
        return;
      }
      const calle = m[1].trim();
      const altura = m[2];

      try{
        // 1) Intento directo: Datos √∫tiles por calle + altura
        const url = `https://ws.usig.buenosaires.gob.ar/datos_utiles?calle=${encodeURIComponent(calle)}&altura=${encodeURIComponent(altura)}`;
        const r = await fetch(url, { headers:{'Accept':'application/json'} });
        if(!r.ok) throw new Error('USIG respondi√≥ con error');
        const data = await r.json();
        if(data && data.barrio){
          barrioDetectado = data.barrio;
          document.getElementById('barrioStatus').innerHTML = `Barrio detectado: <b>${barrioDetectado}</b>`;
          calcular();
          return;
        }
        throw new Error('Sin barrio');
      }catch(e){
        document.getElementById('barrioStatus').innerHTML = '<span class="warn">No pude detectar barrio por la direcci√≥n. Pod√©s escribirlo en el primer rengl√≥n (por ahora solo CABA).</span>';
      }
    }

    function precioBaseBarrio(barrio){
      if(!barrio) return CABA_PROMEDIO_USD_M2;
      // Busco coincidencia tolerante a acentos
      const keys = Object.keys(preciosMudafy);
      const hit = keys.find(k => norm(k) === norm(barrio));
      return hit ? preciosMudafy[hit] : CABA_PROMEDIO_USD_M2;
    }

    function fmtUsd(n){
      return new Intl.NumberFormat('es-AR',{ style:'currency', currency:'USD', maximumFractionDigits:0}).format(n);
    }

    function calcular(){
      const sup = +document.getElementById('sup').value || 0;
      const amb = +document.getElementById('amb').value || 0;
      const ban = +document.getElementById('ban').value || 0;
      const piso = +document.getElementById('piso').value || 0;
      const ant = +document.getElementById('ant').value || 0;
      const estado = +document.getElementById('estado').value;

      // Barrio: si no hay detectado, uso heur√≠stica por texto dentro del campo direcci√≥n
      const txtDir = document.getElementById('direccion').value;
      let barrioTxt = (barrioDetectado || '').trim();
      // Permitimos que el usuario tipe√© "Barrio: Palermo - ..." y lo tome
      const m = txtDir.match(/barrio\s*[:\-]\s*([^,;]+)/i);
      if(!barrioTxt && m) barrioTxt = m[1];

      const usdM2 = precioBaseBarrio(barrioTxt);

      // Ajustes simples y transparentes
      let factor = 1 + estado; // estado general

      if(document.getElementById('coch').checked) factor += 0.04;
      if(document.getElementById('pile').checked) factor += 0.03;
      if(document.getElementById('seg').checked)  factor += 0.03;

      // Penalizaci√≥n por antig√ºedad (suave) y premio por piso alto (si tiene ascensor‚Ä¶ ¬°se asume!)
      if(ant > 40) factor -= 0.05; else if(ant > 20) factor -= 0.02;
      if(piso >= 7) factor += 0.02; // vistas/luz

      // Bonus por distribuci√≥n/ba√±os en relaci√≥n a ambientes
      if(amb >= 3 && ban >= 2) factor += 0.015;

      const precioBase = usdM2 * sup;
      const publicacion = Math.max(0, precioBase * factor);
      const cierre = publicacion * (1 - 0.068);

      document.getElementById('precioPub').textContent = fmtUsd(publicacion);
      document.getElementById('precioCierre').textContent = fmtUsd(cierre);
      document.getElementById('rango').textContent = `‚Ä¢ Rango orientativo: ${fmtUsd(publicacion*0.95)} a ${fmtUsd(publicacion*1.05)}`;

      const barrioMostrado = barrioTxt || '‚Äî (promedio CABA)';
      const baseTxt = (barrioTxt && precioBaseBarrio(barrioTxt) !== CABA_PROMEDIO_USD_M2)
        ? `Base usada: ${barrioTxt}: ${fmtUsd(usdM2)}/m¬≤`
        : `Base usada: CABA promedio: ${fmtUsd(CABA_PROMEDIO_USD_M2)}/m¬≤`;

      document.getElementById('barrioInfo').innerHTML = `Barrio: <b>${barrioMostrado}</b>`;
      document.getElementById('baseInfo').textContent = baseTxt;
      document.getElementById('ajustesInfo').textContent = `Ajustes (estado/amenities/antig√ºedad/piso): ${( (factor-1)*100 ).toFixed(1)}%`;

      // CTA WhatsApp con prefill
      const msg = encodeURIComponent(`Hola! Quiero una tasaci√≥n profesional. Direcci√≥n: ${txtDir}. Barrio: ${barrioMostrado}. Sup: ${sup} m¬≤. Precio web sugerido: ${fmtUsd(publicacion)} (cierre ${fmtUsd(cierre)}).`);
      document.getElementById('ctaWsp').href = `https://wa.me/5491158107778xxxxxxxx?text=${msg}`; // ‚Üê pon√© tu n√∫mero üëà
    }

    // C√°lculo inicial con defaults
    calcular();
  </script>
</body>
</html>
